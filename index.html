<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Convex Chat (with Auth)</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .chat-card {
        height: 85vh;
        max-height: 800px;
        display: flex;
        flex-direction: column;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
      }
      /* Hide elements by default */
      #signed-in,
      #signed-out {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- This div will be shown to signed-out users -->
    <div
      id="signed-out"
      class="container text-center vh-100 d-flex flex-column justify-content-center"
    >
      <h1 class="mb-4">Welcome to Convex Chat</h1>
      <p class="lead">Please sign in to continue.</p>
      <div class="mt-3">
        <button id="sign-in-button" class="btn btn-primary btn-lg">
          Sign In
        </button>
      </div>
    </div>

    <!-- This div will be shown to signed-in users -->
    <main id="signed-in" class="container my-4">
      <div class="card shadow-sm chat-card">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <h1 class="h4 mb-0">Convex Chat</h1>
          <!-- User info and sign out button -->
          <div id="user-info">
            <span id="username-display" class="me-2"></span>
            <button id="sign-out-button" class="btn btn-light btn-sm">
              Sign Out
            </button>
          </div>
        </div>

        <div class="card-body p-0 chat-messages">
          <ul class="list-group list-group-flush messages-list"></ul>
        </div>

        <div class="card-footer p-3">
          <form id="chat-form">
            <div class="input-group">
              <input
                type="text"
                id="message"
                class="form-control"
                placeholder="Type your message..."
                required
              />
              <button class="btn btn-primary" type="submit">Send</button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <!-- Convex and Clerk Client Libraries -->
    <script src="https://unpkg.com/convex@1.3.1/dist/browser.bundle.js"></script>
    <script>
      // IMPORTANT: Replace with your actual Convex and Clerk keys
      const CONVEX_URL = "https://jovial-dodo-936.convex.cloud";
      const CLERK_PUBLISHABLE_KEY =
        "pk_test_Z29yZ2VvdXMtbmV3dC05My5jbGVyay5hY2NvdW50cy5kZXYk"; // <-- PASTE YOUR CLERK PUBLISHABLE KEY HERE

      // Initialize Convex client
      const client = new convex.ConvexClient(CONVEX_URL);
      const api = convex.anyApi;

      // Initialize Clerk frontend
      const clerk = new convex.Clerk(CLERK_PUBLISHABLE_KEY);

      // DOM Elements
      const signedInDiv = document.getElementById("signed-in");
      const signedOutDiv = document.getElementById("signed-out");
      const signInButton = document.getElementById("sign-in-button");
      const signOutButton = document.getElementById("sign-out-button");
      const usernameDisplay = document.getElementById("username-display");
      const chatForm = document.getElementById("chat-form");
      const messageInput = document.getElementById("message");
      const messagesContainer = document.querySelector(".chat-messages");
      const messagesList = document.querySelector(".messages-list");

      let unsubscribe = null;

      // Use Clerk to manage authentication state
      clerk.onUserUpdate(async (user) => {
        client.setAuth(
          async () => await clerk.session?.getToken({ template: "convex" })
        );

        if (user) {
          // User is signed in
          signedInDiv.style.display = "block";
          signedOutDiv.style.display = "none";
          usernameDisplay.textContent =
            user.fullName || user.primaryEmailAddress.emailAddress;

          // Subscribe to messages only when logged in
          if (!unsubscribe) {
            unsubscribe = client.onUpdate(api.messages.list, {}, (messages) => {
              messagesList.innerHTML = "";
              for (const message of messages.reverse()) {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = `<strong>${message.author}:</strong> ${message.body}`;
                messagesList.appendChild(li);
              }
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
          }
        } else {
          // User is signed out
          signedInDiv.style.display = "none";
          signedOutDiv.style.display = "block";

          // Unsubscribe from messages when logged out
          if (unsubscribe) {
            unsubscribe();
            unsubscribe = null;
          }
        }
      });
      clerk.load();

      // Event Listeners for auth buttons
      signInButton.addEventListener("click", () => clerk.openSignIn({}));
      signOutButton.addEventListener("click", () => clerk.signOut());

      // Handle form submission for sending messages
      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
          // The mutation no longer needs an author argument
          client.mutation(api.messages.send, { body: message });
          messageInput.value = "";
          messageInput.focus();
        }
      });
    </script>
  </body>
</html>
